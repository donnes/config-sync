name: Release & Publish
run-name: "release ${{ inputs.bump }}"

on:
  workflow_dispatch:
    inputs:
      bump:
        description: "Bump major, minor, or patch"
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
      preview:
        description: "Preview mode (skip release and publish)"
        required: false
        type: boolean
        default: false

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      version: ${{ steps.release.outputs.version }}
      tag: ${{ steps.release.outputs.tag }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_PAT }}

      - uses: ./.github/actions/setup

      - name: Release
        id: release
        run: bun run scripts/release.ts
        env:
          BUMP: ${{ inputs.bump }}
          PREVIEW: ${{ inputs.preview }}
          GH_TOKEN: ${{ secrets.GH_PAT }}

  publish:
    needs: release
    if: ${{ !inputs.preview }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.release.outputs.tag }}

      - uses: ./.github/actions/setup

      - name: Publish to NPM
        run: bun run scripts/publish.ts
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
